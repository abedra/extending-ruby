<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
               "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>Extending Ruby With C</title>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
<meta name="title" content="Extending Ruby With C"/>
<meta name="generator" content="Org-mode"/>
<meta name="generated" content="2012-02-07 08:40:01 CST"/>
<meta name="author" content="Aaron Bedra"/>
<meta name="description" content=""/>
<meta name="keywords" content=""/>
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  html { font-family: Times, serif; font-size: 12pt; }
  .title  { text-align: center; }
  .todo   { color: red; }
  .done   { color: green; }
  .tag    { background-color: #add8e6; font-weight:normal }
  .target { }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  {margin-left:auto; margin-right:0px;  text-align:right;}
  .left   {margin-left:0px;  margin-right:auto; text-align:left;}
  .center {margin-left:auto; margin-right:auto; text-align:center;}
  p.verse { margin-left: 3% }
  pre {
	border: 1pt solid #AEBDCC;
	background-color: #F3F5F7;
	padding: 5pt;
	font-family: courier, monospace;
        font-size: 90%;
        overflow:auto;
  }
  table { border-collapse: collapse; }
  td, th { vertical-align: top;  }
  th.right  { text-align:center;  }
  th.left   { text-align:center;   }
  th.center { text-align:center; }
  td.right  { text-align:right;  }
  td.left   { text-align:left;   }
  td.center { text-align:center; }
  dt { font-weight: bold; }
  div.figure { padding: 0.5em; }
  div.figure p { text-align: center; }
  div.inlinetask {
    padding:10px;
    border:2px solid gray;
    margin:10px;
    background: #ffffcc;
  }
  textarea { overflow-x: auto; }
  .linenr { font-size:smaller }
  .code-highlighted {background-color:#ffff00;}
  .org-info-js_info-navigation { border-style:none; }
  #org-info-js_console-label { font-size:10px; font-weight:bold;
                               white-space:nowrap; }
  .org-info-js_search-highlight {background-color:#ffff00; color:#000000;
                                 font-weight:bold; }
  /*]]>*/-->
</style>
<script type="text/javascript">
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>

</head>
<body>

<div id="preamble">

</div>

<div id="content">
<h1 class="title">Extending Ruby With C</h1>


<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1 Getting Started</a>
<ul>
<li><a href="#sec-1-1">1.1 Initial Code</a></li>
<li><a href="#sec-1-2">1.2 Initial Gemspec</a></li>
<li><a href="#sec-1-3">1.3 Building and testing the gem</a></li>
</ul>
</li>
<li><a href="#sec-2">2 Testing</a>
<ul>
<li><a href="#sec-2-1">2.1 Adding the first test</a></li>
<li><a href="#sec-2-2">2.2 Adding a Rake task</a></li>
<li><a href="#sec-2-3">2.3 Running our tests</a></li>
</ul>
</li>
<li><a href="#sec-3">3 How fast is it?</a>
<ul>
<li><a href="#sec-3-1">3.1 Timing a run</a></li>
<li><a href="#sec-3-2">3.2 Should we stop here?</a></li>
</ul>
</li>
<li><a href="#sec-4">4 Experiment: XPath search in C with libxml</a>
<ul>
<li><a href="#sec-4-1">4.1 The test</a></li>
<li><a href="#sec-4-2">4.2 Compiling</a></li>
<li><a href="#sec-4-3">4.3 How fast is the C version?</a></li>
</ul>
</li>
<li><a href="#sec-5">5 Adding the extension infrastructure</a>
<ul>
<li><a href="#sec-5-1">5.1 Directory structure</a></li>
<li><a href="#sec-5-2">5.2 extconf.rb</a></li>
<li><a href="#sec-5-3">5.3 A simple example</a></li>
<li><a href="#sec-5-4">5.4 Updating the gemspec</a></li>
<li><a href="#sec-5-5">5.5 Trying out the extension</a></li>
<li><a href="#sec-5-6">5.6 Adding a test</a></li>
<li><a href="#sec-5-7">5.7 Updating the Rakefile to autocompile for tests</a></li>
</ul>
</li>
<li><a href="#sec-6">6 Moving the example into a real Ruby extension</a>
<ul>
<li><a href="#sec-6-1">6.1 How should the API look?</a>
<ul>
<li><a href="#sec-6-1-1">6.1.1 A note about GC and memory management</a></li>
</ul>
</li>
<li><a href="#sec-6-2">6.2 Object creation</a></li>
<li><a href="#sec-6-3">6.3 When the basic constructor just won't do</a></li>
<li><a href="#sec-6-4">6.4 Freeing the memory</a></li>
<li><a href="#sec-6-5">6.5 Wiring up our new constructor</a></li>
<li><a href="#sec-6-6">6.6 Putting it all together</a></li>
</ul>
</li>
<li><a href="#sec-7">7 The results!</a></li>
<li><a href="#sec-8">8 References</a></li>
</ul>
</div>
</div>

<div id="outline-container-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Getting Started</h2>
<div class="outline-text-2" id="text-1">

<ul>
<li>There's a lot to cover when it comes to extending Ruby. To
    demonstrate the point, we will start by creating a basic ruby gem
    written entirely in Ruby, and modify it as we go.
</li>
<li>We will start with the basic structure of a gem. We first need to
    create a folder that will house everything.
</li>
</ul>




<pre class="src src-sh">$ mkdir xpanther
</pre>


</div>

<div id="outline-container-1-1" class="outline-3">
<h3 id="sec-1-1"><span class="section-number-3">1.1</span> Initial Code</h3>
<div class="outline-text-3" id="text-1-1">

<ul>
<li>Let's put in our foundation:
</li>
</ul>


<strong><i>lib/xpanther.rb</i></strong>

<pre class="src src-ruby">require <span style="color: #8b2252;">'rexml/document'</span>

<span style="color: #7f007f;">class</span> <span style="color: #228b22;">XPanther</span>
  <span style="color: #7f007f;">def</span> <span style="color: #0000ff;">self.search_pure</span>(filename, xpath)
    document = <span style="color: #228b22;">REXML</span>::<span style="color: #228b22;">Document</span>.new(<span style="color: #228b22;">File</span>.read(filename))
    <span style="color: #228b22;">REXML</span>::<span style="color: #228b22;">XPath</span>.match(document.root, xpath)
  <span style="color: #7f007f;">end</span>
<span style="color: #7f007f;">end</span>
</pre>

</div>

</div>

<div id="outline-container-1-2" class="outline-3">
<h3 id="sec-1-2"><span class="section-number-3">1.2</span> Initial Gemspec</h3>
<div class="outline-text-3" id="text-1-2">

<ul>
<li>Next we need to tell Rubygems how to build and package this gem:
</li>
</ul>


<strong><i>xpanther.gemspec</i></strong>

<pre class="src src-ruby"><span style="color: #228b22;">Gem</span>::<span style="color: #228b22;">Specification</span>.new <span style="color: #7f007f;">do</span> |s|
  s.name        = <span style="color: #8b2252;">'xpanther'</span>
  s.version     = <span style="color: #8b2252;">'0.0.0'</span>
  s.date        = <span style="color: #8b2252;">'2012-02-21'</span>
  s.summary     = <span style="color: #8b2252;">"Made with real bits of panther"</span>
  s.description = <span style="color: #8b2252;">"60% of the time it works all the time"</span>
  s.authors     = [<span style="color: #8b2252;">"Aaron Bedra"</span>]
  s.email       = <span style="color: #8b2252;">'aaron@aaronbedra.com'</span>
  s.files       = [<span style="color: #8b2252;">"lib/xpanther.rb"</span>]
  s.homepage    = <span style="color: #8b2252;">"http://example.com"</span>
<span style="color: #7f007f;">end</span>
</pre>

</div>

</div>

<div id="outline-container-1-3" class="outline-3">
<h3 id="sec-1-3"><span class="section-number-3">1.3</span> Building and testing the gem</h3>
<div class="outline-text-3" id="text-1-3">

<ul>
<li>To test the gem we need to build and install it:
</li>
</ul>




<pre class="src src-sh">$ gem build xpanther.gemspec
$ gem install xpanther-0.0.0.gem
</pre>

<ul>
<li>We also need some test data. Let's grab a copy of the twitter public timeline:
</li>
</ul>




<pre class="src src-sh">mkdir examples
curl http://api.twitter.com/1/statuses/public_timeline.xml &gt; examples/twitter.xml
</pre>

<ul>
<li>Let's start an irb session using the new gem:
</li>
</ul>




<pre class="src src-sh">$ irb -rubygems -rxpanther
</pre>


<pre class="src src-sh">&gt;&gt; XPanther.search_pure(<span style="color: #8b2252;">"examples/twitter.xml"</span>, <span style="color: #8b2252;">"/statuses/status/text/text()"</span>).count
=&gt; 20
&gt;&gt; XPanther.search_pure(<span style="color: #8b2252;">"examples/twitter.xml"</span>, <span style="color: #8b2252;">"/statuses/status/text/text()"</span>).first
=&gt; <span style="color: #8b2252;">"Hoje sai com a @is_nanny"</span>
</pre>

</div>
</div>

</div>

<div id="outline-container-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Testing</h2>
<div class="outline-text-2" id="text-2">


</div>

<div id="outline-container-2-1" class="outline-3">
<h3 id="sec-2-1"><span class="section-number-3">2.1</span> Adding the first test</h3>
<div class="outline-text-3" id="text-2-1">

<ul>
<li>We should add at least one test to make sure things are in place
     and behaving like we expect them to:
</li>
</ul>


<strong><i>test/test_xpanther.rb</i></strong>

<pre class="src src-ruby">require <span style="color: #8b2252;">'test/unit'</span>
require <span style="color: #8b2252;">'xpanther'</span>

<span style="color: #7f007f;">class</span> <span style="color: #228b22;">XPantherTest</span> &lt; <span style="color: #228b22;">Test</span>::<span style="color: #228b22;">Unit</span>::<span style="color: #228b22;">TestCase</span>
  <span style="color: #7f007f;">def</span> <span style="color: #0000ff;">test_search_pure</span>
    results = <span style="color: #228b22;">XPanther</span>.search_pure(<span style="color: #8b2252;">"examples/twitter.xml"</span>, <span style="color: #8b2252;">"/statuses/status/text/text()"</span>)
    assert_equal(20, results.count)
    assert_equal(<span style="color: #8b2252;">"Hoje sai com a @is_nanny"</span>, results.first.to_s)
  <span style="color: #7f007f;">end</span>
<span style="color: #7f007f;">end</span>
</pre>

</div>

</div>

<div id="outline-container-2-2" class="outline-3">
<h3 id="sec-2-2"><span class="section-number-3">2.2</span> Adding a Rake task</h3>
<div class="outline-text-3" id="text-2-2">

<ul>
<li>It's always easier to control things via <code>Rake</code>
</li>
</ul>


<strong><i>Rakefile</i></strong>

<pre class="src src-ruby">require <span style="color: #8b2252;">'rake/testtask'</span>

<span style="color: #228b22;">Rake</span>::<span style="color: #228b22;">TestTask</span>.new <span style="color: #7f007f;">do</span> |t|
  t.libs &lt;&lt; <span style="color: #8b2252;">"test"</span>
<span style="color: #7f007f;">end</span>

task <span style="color: #008b8b;">:default</span> =&gt; <span style="color: #008b8b;">:test</span>
</pre>

</div>

</div>

<div id="outline-container-2-3" class="outline-3">
<h3 id="sec-2-3"><span class="section-number-3">2.3</span> Running our tests</h3>
<div class="outline-text-3" id="text-2-3">

<ul>
<li>With the default task wired up we can just run <code>rake</code>. Here's what you should see
</li>
</ul>




<pre class="src src-sh">Loaded suite /Users/abedra/.rvm/gems/ree-1.8.7-2011.12/gems/rake-0.9.2.2/lib/rake/rake_test_loader
Started
.
Finished<span style="color: #7f007f;"> in</span> 0.090969 seconds.

1 tests, 2 assertions, 0 failures, 0 errors
</pre>

</div>
</div>

</div>

<div id="outline-container-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> How fast is it?</h2>
<div class="outline-text-2" id="text-3">


</div>

<div id="outline-container-3-1" class="outline-3">
<h3 id="sec-3-1"><span class="section-number-3">3.1</span> Timing a run</h3>
<div class="outline-text-3" id="text-3-1">

<ul>
<li>We can now use our gem to see how fast it takes to ask some
     questions about the sample xml document.
</li>
</ul>


<strong><i>examples/pure.rb</i></strong>

<pre class="src src-ruby">require <span style="color: #8b2252;">'rubygems'</span>
require <span style="color: #8b2252;">'xpanther'</span>

results = <span style="color: #228b22;">XPanther</span>.search_pure(<span style="color: #8b2252;">"examples/twitter.xml"</span>, <span style="color: #8b2252;">"/statuses/status/text/text()"</span>)
puts results.count
puts results[1]
</pre>

<ul>
<li>Now we can time run of this to see how we're doing on performance
</li>
</ul>




<pre class="src src-sh">$ time ruby examples/pure.rb
20
gelitik cewe paling binal dan buset ,,
ruby examples/pure.rb  0.15s user 0.01s system 98% cpu 0.167 total
</pre>

</div>

</div>

<div id="outline-container-3-2" class="outline-3">
<h3 id="sec-3-2"><span class="section-number-3">3.2</span> Should we stop here?</h3>
<div class="outline-text-3" id="text-3-2">

</div>
</div>

</div>

<div id="outline-container-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> Experiment: XPath search in C with libxml</h2>
<div class="outline-text-2" id="text-4">

<ul>
<li>libxml is a very widely used library in the XML parsing game. If
    you are in C and need to get the job done, libxml is your best
    friend
</li>
</ul>


</div>

<div id="outline-container-4-1" class="outline-3">
<h3 id="sec-4-1"><span class="section-number-3">4.1</span> The test</h3>
<div class="outline-text-3" id="text-4-1">


<strong><i>examples/xml.c</i></strong>

<pre class="src src-c"><span style="color: #483d8b;">#include</span> <span style="color: #8b2252;">&lt;stdlib.h&gt;</span>
<span style="color: #483d8b;">#include</span> <span style="color: #8b2252;">&lt;stdio.h&gt;</span>
<span style="color: #483d8b;">#include</span> <span style="color: #8b2252;">&lt;libxml/tree.h&gt;</span>
<span style="color: #483d8b;">#include</span> <span style="color: #8b2252;">&lt;libxml/parser.h&gt;</span>
<span style="color: #483d8b;">#include</span> <span style="color: #8b2252;">&lt;libxml/xpath.h&gt;</span>
<span style="color: #483d8b;">#include</span> <span style="color: #8b2252;">&lt;libxml/xpathInternals.h&gt;</span>

<span style="color: #228b22;">int</span> <span style="color: #0000ff;">search</span>(<span style="color: #7f007f;">const</span> <span style="color: #228b22;">char</span>* <span style="color: #a0522d;">filename</span>, <span style="color: #7f007f;">const</span> <span style="color: #228b22;">xmlChar</span>* <span style="color: #a0522d;">xpathExpr</span>) {
  <span style="color: #228b22;">xmlDocPtr</span> <span style="color: #a0522d;">doc</span>;
  <span style="color: #228b22;">xmlXPathContextPtr</span> <span style="color: #a0522d;">xpathCtx</span>;
  <span style="color: #228b22;">xmlXPathObjectPtr</span> <span style="color: #a0522d;">xpathObj</span>;
  <span style="color: #228b22;">xmlNodePtr</span> <span style="color: #a0522d;">cur</span>;
  <span style="color: #228b22;">xmlNodeSetPtr</span> <span style="color: #a0522d;">nodes</span>;
  <span style="color: #228b22;">int</span> <span style="color: #a0522d;">size</span>;
  <span style="color: #228b22;">int</span> <span style="color: #a0522d;">i</span>;

  doc = xmlParseFile(filename);
  xpathCtx = xmlXPathNewContext(doc);
  xpathObj = xmlXPathEvalExpression(xpathExpr, xpathCtx);

  nodes = xpathObj-&gt;nodesetval;
  size = (nodes) ? nodes-&gt;nodeNr : 0;

  <span style="color: #7f007f;">if</span> (size == 1) {
    fprintf(stderr, <span style="color: #8b2252;">"%s\n"</span>, xmlNodeGetContent(nodes-&gt;nodeTab[0]));
  } <span style="color: #7f007f;">else</span> {
    <span style="color: #7f007f;">for</span> (i = 0; i &lt; size; ++i) {
      cur = nodes-&gt;nodeTab[i];
      fprintf(stderr, <span style="color: #8b2252;">"%s\n"</span>, xmlNodeGetContent(cur));
    }
  }

  xmlXPathFreeObject(xpathObj);
  xmlXPathFreeContext(xpathCtx);
  xmlFreeDoc(doc);

  <span style="color: #7f007f;">return</span>(0);
}

<span style="color: #228b22;">int</span> <span style="color: #0000ff;">main</span>(<span style="color: #228b22;">int</span> <span style="color: #a0522d;">argc</span>, <span style="color: #228b22;">char</span> **<span style="color: #a0522d;">argv</span>) {
  xmlInitParser();
  search(argv[1], argv[2]);
  xmlCleanupParser();
  xmlMemoryDump();
  <span style="color: #7f007f;">return</span> 0;
}
</pre>

</div>

</div>

<div id="outline-container-4-2" class="outline-3">
<h3 id="sec-4-2"><span class="section-number-3">4.2</span> Compiling</h3>
<div class="outline-text-3" id="text-4-2">

<ul>
<li>You can compile the example using the following command:
</li>
</ul>




<pre class="src src-sh">gcc xml.c -o xml <span style="color: #ff00ff;">`xml2-config --cflags`</span> <span style="color: #ff00ff;">`xml2-config --libs`</span>
</pre>

</div>

</div>

<div id="outline-container-4-3" class="outline-3">
<h3 id="sec-4-3"><span class="section-number-3">4.3</span> How fast is the C version?</h3>
<div class="outline-text-3" id="text-4-3">




<pre class="src src-sh"><span style="color: #483d8b;">time</span> ./xml twitter.xml <span style="color: #8b2252;">"/statuses/status/text"</span>

Hoje sai com a @is_nanny
gelitik cewe paling binal dan buset ,,
&#12417;&#12387;&#12373;&#12402;&#12414;&#12420;&#12391;&#65281;

....

/xml twitter.xml <span style="color: #8b2252;">"/statuses/status/text"</span>  0.00s user 0.00s system 40% cpu 0.0010 total
</pre>

<ul>
<li>Without too much modification we can turn this into a Ruby C extension
</li>
</ul>

</div>
</div>

</div>

<div id="outline-container-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> Adding the extension infrastructure</h2>
<div class="outline-text-2" id="text-5">


</div>

<div id="outline-container-5-1" class="outline-3">
<h3 id="sec-5-1"><span class="section-number-3">5.1</span> Directory structure</h3>
<div class="outline-text-3" id="text-5-1">

<ul>
<li>When adding a C extension, the common folder structure is
     <code>ext/gemname/*.c</code>. We will create the <code>ext/xpanther</code> directory and
     create a file called <code>extconf.rb</code> in the xpanther folder.
</li>
</ul>

</div>

</div>

<div id="outline-container-5-2" class="outline-3">
<h3 id="sec-5-2"><span class="section-number-3">5.2</span> extconf.rb</h3>
<div class="outline-text-3" id="text-5-2">

<ul>
<li><code>extconf.rb</code> will generate a <code>Makefile</code> for the project. It is
     also what you will add to the gemspec to tell it how to build
     your extension.
</li>
</ul>


<strong><i>ext/xpanther/extconf.rb</i></strong>

<pre class="src src-ruby">require <span style="color: #8b2252;">'mkmf'</span>
create_makefile(<span style="color: #8b2252;">'xpanther/xpanther'</span>)
</pre>

</div>

</div>

<div id="outline-container-5-3" class="outline-3">
<h3 id="sec-5-3"><span class="section-number-3">5.3</span> A simple example</h3>
<div class="outline-text-3" id="text-5-3">

<ul>
<li>Now we just need to add a short example to test our structure and wiring.
</li>
</ul>


<strong><i>ext/xpanther/xpanther.c</i></strong>

<pre class="src src-c"><span style="color: #483d8b;">#include</span> <span style="color: #8b2252;">&lt;ruby.h&gt;</span>

<span style="color: #7f007f;">static</span> <span style="color: #228b22;">VALUE</span> <span style="color: #0000ff;">hello</span>(<span style="color: #228b22;">VALUE</span> <span style="color: #a0522d;">self</span>) {
  <span style="color: #7f007f;">return</span> rb_str_new2(<span style="color: #8b2252;">"Hello from C"</span>);
}

<span style="color: #228b22;">void</span> <span style="color: #0000ff;">Init_xpanther</span>(<span style="color: #228b22;">void</span>) {
  <span style="color: #228b22;">VALUE</span> <span style="color: #a0522d;">klass</span> = rb_define_class(<span style="color: #8b2252;">"XPanther"</span>, rb_cObject);
  rb_define_singleton_method(klass, <span style="color: #8b2252;">"hello"</span>, hello, 0);
}
</pre>

<ul>
<li>We also need to have our gem load the extension
</li>
</ul>


<strong><i>lib/xpanther.rb</i></strong>

<pre class="src src-ruby">require <span style="color: #8b2252;">'xpanther/xpanther'</span>
require <span style="color: #8b2252;">'rexml/document'</span>
<span style="color: #7f007f;">class</span> <span style="color: #228b22;">XPanther</span>

....
</pre>

</div>

</div>

<div id="outline-container-5-4" class="outline-3">
<h3 id="sec-5-4"><span class="section-number-3">5.4</span> Updating the gemspec</h3>
<div class="outline-text-3" id="text-5-4">

<ul>
<li>In order to have the extension built when our gem is installed, we have to tell the gemspec about it.
</li>
</ul>


<strong><i>xpanther.gemspec</i></strong>

<pre class="src src-ruby"><span style="color: #228b22;">Gem</span>::<span style="color: #228b22;">Specification</span>.new <span style="color: #7f007f;">do</span> |s|
  <span style="color: #b22222;"># </span><span style="color: #b22222;">... (other stuff) ...</span>

  s.files = <span style="color: #228b22;">Dir</span>.glob(<span style="color: #8b2252;">'lib/**/*.rb'</span>) + <span style="color: #228b22;">Dir</span>.glob(<span style="color: #8b2252;">'ext/**/*.c'</span>)
  s.extensions = [<span style="color: #8b2252;">'ext/xpanther/extconf.rb'</span>]

  <span style="color: #b22222;"># </span><span style="color: #b22222;">... (other stuff) ...</span>
<span style="color: #7f007f;">end</span>
</pre>

</div>

</div>

<div id="outline-container-5-5" class="outline-3">
<h3 id="sec-5-5"><span class="section-number-3">5.5</span> Trying out the extension</h3>
<div class="outline-text-3" id="text-5-5">

<ul>
<li>Let's install our gem and give the new method a try. Since we
     have made significant changes we should bump the version number
     as well.
</li>
</ul>




<pre class="src src-sh">$ gem install xpanther-0.0.1.gem 
Building native extensions.  This could take a while...
Successfully installed xpanther-0.0.1
1 gem installed
Installing ri documentation for xpanther-0.0.1...
Installing RDoc documentation for xpanther-0.0.1...
</pre>

<ul>
<li>Notice the new message about building the native extension. If
     you don't see that, your extension is not being installed.
</li>
<li>Fire up and irb session and run the new method:
</li>
</ul>




<pre class="src src-sh">$ irb -rubygems -rxpanther
&gt;&gt; XPanther.hello
=&gt; <span style="color: #8b2252;">"Hello from C"</span>
</pre>

</div>

</div>

<div id="outline-container-5-6" class="outline-3">
<h3 id="sec-5-6"><span class="section-number-3">5.6</span> Adding a test</h3>
<div class="outline-text-3" id="text-5-6">

<ul>
<li>We are going to add a test for our new extension. You might be
     wondering why, but it will present an interesting challenge for
     us to solve when we try to run the tests.
</li>
</ul>


<strong><i>test/test_xpanther.rb</i></strong>

<pre class="src src-ruby"><span style="color: #7f007f;">def</span> <span style="color: #0000ff;">test_extension</span>
  assert_equal(<span style="color: #8b2252;">"Hello from C"</span>, <span style="color: #228b22;">XPanther</span>.hello)
<span style="color: #7f007f;">end</span>  
</pre>

</div>

</div>

<div id="outline-container-5-7" class="outline-3">
<h3 id="sec-5-7"><span class="section-number-3">5.7</span> Updating the Rakefile to autocompile for tests</h3>
<div class="outline-text-3" id="text-5-7">

<ul>
<li>When we try to run <code>rake</code> we are now presented with an error.
</li>
</ul>




<pre class="src src-sh">$ rake
./lib/xpanther.rb:1:in <span style="color: #8b2252;">'require'</span>: no such file to load -- xpanther/xpanther (LoadError)
from ./lib/xpanther.rb:1

....
</pre>

<ul>
<li>This error is caused because our extension is not compiled and
     available for our tests. Luckily, there's an easy solution to
     this.
</li>
<li>Before we open our <code>Rakefile</code>, we should do a quick test on our system in irb
</li>
</ul>




<pre class="src src-sh">$ irb -rrbconfig
&gt;&gt; RbConfig::CONFIG[<span style="color: #8b2252;">'DLEXT'</span>]
=&gt; <span style="color: #8b2252;">"bundle"</span>
</pre>

<ul>
<li>This let's us know that the compiled extension will have the file
     extension of <code>.bundle</code>. If you are on Linux you would see <code>.so</code>
     instead of .bundle
</li>
<li>Let's add some code into our <code>Rakefile</code> to automatically compile our extension when we run <code>rake</code>
</li>
</ul>


<strong><i>Rakefile</i></strong>

<pre class="src src-ruby">require <span style="color: #8b2252;">'rake/testtask'</span>
require <span style="color: #8b2252;">'rake/clean'</span>
require <span style="color: #8b2252;">'rbconfig'</span>
require <span style="color: #8b2252;">'fileutils'</span>

<span style="color: #228b22;">EXT</span> = <span style="color: #228b22;">RbConfig</span>::<span style="color: #228b22;">CONFIG</span>[<span style="color: #8b2252;">'DLEXT'</span>]

file <span style="color: #8b2252;">"lib/xpanther/xpanther.</span><span style="color: #a0522d;">#{EXT}</span><span style="color: #8b2252;">"</span> =&gt; <span style="color: #228b22;">Dir</span>.glob(<span style="color: #8b2252;">'ext/xpanther/*.c'</span>) <span style="color: #7f007f;">do</span>
  <span style="color: #228b22;">Dir</span>.chdir(<span style="color: #8b2252;">'ext/xpanther'</span>) <span style="color: #7f007f;">do</span>
    ruby <span style="color: #8b2252;">"extconf.rb"</span>
    sh <span style="color: #8b2252;">"make"</span>
  <span style="color: #7f007f;">end</span>
  <span style="color: #228b22;">FileUtils</span>.mkdir_p(<span style="color: #8b2252;">'lib/xpanther'</span>)
  cp <span style="color: #8b2252;">"ext/xpanther/xpanther.</span><span style="color: #a0522d;">#{EXT}</span><span style="color: #8b2252;">"</span>, <span style="color: #8b2252;">"lib/xpanther/xpanther.</span><span style="color: #a0522d;">#{EXT}</span><span style="color: #8b2252;">"</span>
<span style="color: #7f007f;">end</span>

task <span style="color: #008b8b;">:test</span> =&gt; <span style="color: #8b2252;">"lib/xpanther/xpanther.</span><span style="color: #a0522d;">#{EXT}</span><span style="color: #8b2252;">"</span>

<span style="color: #228b22;">CLEAN</span>.include(<span style="color: #8b2252;">'ext/**/*{.o,.log,.</span><span style="color: #a0522d;">#{EXT}</span><span style="color: #8b2252;">}'</span>)
<span style="color: #228b22;">CLEAN</span>.include(<span style="color: #8b2252;">'ext/**/Makefile'</span>)
<span style="color: #228b22;">CLOBBER</span>.include(<span style="color: #8b2252;">'lib/**/*.</span><span style="color: #a0522d;">#{EXT}</span><span style="color: #8b2252;">'</span>)

<span style="color: #228b22;">Rake</span>::<span style="color: #228b22;">TestTask</span>.new <span style="color: #7f007f;">do</span> |t|
  t.libs &lt;&lt; <span style="color: #8b2252;">'test'</span>
<span style="color: #7f007f;">end</span>

desc <span style="color: #8b2252;">"Run tests"</span>
task <span style="color: #008b8b;">:default</span> =&gt; <span style="color: #008b8b;">:test</span>
</pre>

</div>
</div>

</div>

<div id="outline-container-6" class="outline-2">
<h2 id="sec-6"><span class="section-number-2">6</span> Moving the example into a real Ruby extension</h2>
<div class="outline-text-2" id="text-6">


</div>

<div id="outline-container-6-1" class="outline-3">
<h3 id="sec-6-1"><span class="section-number-3">6.1</span> How should the API look?</h3>
<div class="outline-text-3" id="text-6-1">

<ul>
<li>There's quite a few different ways to create an API. Since we
     know that we are going to perform an XPath search when we
     instantiate our class, it would be nice to have it go ahead and
     preprocess the xml into memory for us. This obivously has
     limitations based on file size, but we are going to ignore that
     for the purposes of this example.
</li>
</ul>


</div>

<div id="outline-container-6-1-1" class="outline-4">
<h4 id="sec-6-1-1"><span class="section-number-4">6.1.1</span> A note about GC and memory management</h4>
<div class="outline-text-4" id="text-6-1-1">

<ul>
<li>Note that in our C example libxml created and freed the
      memory. Ruby will not be able to handle the cleanup here and we
      will introduce a memory leak if we ignore this.
</li>
</ul>

</div>
</div>

</div>

<div id="outline-container-6-2" class="outline-3">
<h3 id="sec-6-2"><span class="section-number-3">6.2</span> Object creation</h3>
<div class="outline-text-3" id="text-6-2">

<ul>
<li>When we create the object we should parse the XML document into
     memory and make it available for reference. Here's what our
     object creation will look like.
</li>
</ul>




<pre class="src src-ruby">document = <span style="color: #228b22;">XPanther</span>.new(<span style="color: #8b2252;">"/path/to/document.xml"</span>)
</pre>

</div>

</div>

<div id="outline-container-6-3" class="outline-3">
<h3 id="sec-6-3"><span class="section-number-3">6.3</span> When the basic constructor just won't do</h3>
<div class="outline-text-3" id="text-6-3">

<ul>
<li>Since libxml needs to manage its own memory here, we will need to
     modify the constructor just a bit to account for this.
</li>
</ul>


<strong><i>ext/xpanther/xpanther.c</i></strong>

<pre class="src src-c"><span style="color: #228b22;">VALUE</span> <span style="color: #0000ff;">constructor</span>(<span style="color: #228b22;">VALUE</span> <span style="color: #a0522d;">self</span>, <span style="color: #228b22;">VALUE</span> <span style="color: #a0522d;">filename</span>) 
{
  <span style="color: #228b22;">xmlDocPtr</span> <span style="color: #a0522d;">doc</span>;  
  <span style="color: #228b22;">VALUE</span> <span style="color: #a0522d;">argv</span>[1];
  <span style="color: #228b22;">VALUE</span> <span style="color: #a0522d;">t_data</span>;

  doc = xmlParseFile(StringValueCStr(filename));
  <span style="color: #7f007f;">if</span> (doc == <span style="color: #008b8b;">NULL</span>) {
    fprintf(stderr, <span style="color: #8b2252;">"Error: unable to parse file \"%s\"\n"</span>, StringValueCStr(filename));
    <span style="color: #7f007f;">return</span> Qnil;
  }

  t_data = Data_Wrap_Struct(self, 0, xml_free, doc);
  argv[0] = filename;
  rb_obj_call_init(t_data, 1, argv);
  <span style="color: #7f007f;">return</span> t_data;
}
</pre>

<ul>
<li>There's a few new ideas going on here. We are accepting a
     filename as an argument to our constructor. This is then
     converted from a Ruby string to a C string via the
     <code>StringValueCStr</code> function and passed into <code>xmlParseFile</code>. Error
     checking is important here. If the user passes in an invalid
     argument we want to notify them and return nil. We then have to
     take our variable and wrap them in an object representation for
     Ruby. We can do this via <code>Data_Wrap_Struct</code>. We have to provide
     it the object reference, a mark for garbage collection, a pointer
     to the function to call when it's time to free the memory, and a
     pointer to the data that we want to stuff inside. We will examine
     the <code>xml_free</code> function in a minute. Finally, we will manually
     initialize our object with <code>rb_obj_call_init</code> and feed it our
     object data, argument count, and argument data. This is the C way
     to manually create a constructor for a Ruby class.
</li>
</ul>

</div>

</div>

<div id="outline-container-6-4" class="outline-3">
<h3 id="sec-6-4"><span class="section-number-3">6.4</span> Freeing the memory</h3>
<div class="outline-text-3" id="text-6-4">

<ul>
<li>Previously, we pointed to a function called <code>xml_free</code> that is
     supposed to instruct Ruby's garbage collection routines on how to
     deal with the memory allocated by libxml during object
     construction. Let's take a look.
</li>
</ul>


<strong><i>ext/xpanther/xpanther.c</i></strong>

<pre class="src src-c"><span style="color: #7f007f;">static</span> <span style="color: #228b22;">void</span> <span style="color: #0000ff;">xml_free</span>(<span style="color: #228b22;">void</span> *<span style="color: #a0522d;">doc</span>) {
  xmlFreeDoc(doc);
}
</pre>

<ul>
<li>All we are doing here is delegating the memory management to
     libxml. We just have to pass the function a pointer to the
     document in memory.
</li>
</ul>

</div>

</div>

<div id="outline-container-6-5" class="outline-3">
<h3 id="sec-6-5"><span class="section-number-3">6.5</span> Wiring up our new constructor</h3>
<div class="outline-text-3" id="text-6-5">

<ul>
<li>In order for us to be able to accept an argument in our
     constructor, we also need to create an initialize method.
</li>
</ul>


<strong><i>ext/xpanther/xpanther.c</i></strong>

<pre class="src src-c"><span style="color: #7f007f;">static</span> <span style="color: #228b22;">VALUE</span> <span style="color: #0000ff;">initialize</span>(<span style="color: #228b22;">VALUE</span> <span style="color: #a0522d;">self</span>, <span style="color: #228b22;">VALUE</span> <span style="color: #a0522d;">filename</span>) 
{
  rb_iv_set(self, <span style="color: #8b2252;">"@filename"</span>, filename);
  <span style="color: #7f007f;">return</span> self;
}
</pre>

<ul>
<li>We have a new constructor that will serve our purpose well, but
     we still need to wire it up to our object inside the
     <code>Init_xpanther</code> function.
</li>
</ul>


<strong><i>ext/xpanther/xpanther.c</i></strong>

<pre class="src src-c"><span style="color: #228b22;">void</span> <span style="color: #0000ff;">Init_xpanther</span>(<span style="color: #228b22;">void</span>)
{
  <span style="color: #228b22;">VALUE</span> <span style="color: #a0522d;">klass</span> = rb_define_class(<span style="color: #8b2252;">"XPanther"</span>, rb_cObject);
  rb_define_singleton_method(klass, <span style="color: #8b2252;">"new"</span>, constructor, 1);
  rb_define_method(klass, <span style="color: #8b2252;">"initialize"</span>, initialize, 1);
}
</pre>

<ul>
<li>Here we are defining what the <code>new</code> method is going to do. In
     this case, we are going to use our constructor and the cycle is
     complete.
</li>
</ul>

</div>

</div>

<div id="outline-container-6-6" class="outline-3">
<h3 id="sec-6-6"><span class="section-number-3">6.6</span> Putting it all together</h3>
<div class="outline-text-3" id="text-6-6">

<ul>
<li>We have all the structure in place. We just have to drop our
     search routine in place and wire it up and our task will be
     complete. Let's define our <code>search</code> method.
</li>
</ul>


<strong><i>ext/xpanther/xpanther.c</i></strong>

<pre class="src src-c"><span style="color: #228b22;">VALUE</span> <span style="color: #0000ff;">search</span>(<span style="color: #228b22;">VALUE</span> <span style="color: #a0522d;">self</span>, <span style="color: #228b22;">VALUE</span> <span style="color: #a0522d;">xpathExpr</span>)
{
  <span style="color: #228b22;">VALUE</span> <span style="color: #a0522d;">results</span> = rb_ary_new();
  <span style="color: #228b22;">xmlDocPtr</span> <span style="color: #a0522d;">doc</span>;
  <span style="color: #228b22;">xmlXPathContextPtr</span> <span style="color: #a0522d;">xpathCtx</span>;
  <span style="color: #228b22;">xmlXPathObjectPtr</span> <span style="color: #a0522d;">xpathObj</span>;
  <span style="color: #228b22;">xmlNodeSetPtr</span> <span style="color: #a0522d;">nodes</span>;
  <span style="color: #228b22;">xmlNodePtr</span> <span style="color: #a0522d;">cur</span>;
  <span style="color: #228b22;">int</span> <span style="color: #a0522d;">size</span>;
  <span style="color: #228b22;">int</span> <span style="color: #a0522d;">i</span>;

  Data_Get_Struct(self, xmlDoc, doc);

  xpathCtx = xmlXPathNewContext(doc);
  <span style="color: #7f007f;">if</span> (xpathCtx == <span style="color: #008b8b;">NULL</span>) {
    fprintf(stderr, <span style="color: #8b2252;">"Error: unable to create new XPath context\n"</span>);
    xmlFreeDoc(doc);
    <span style="color: #7f007f;">return</span> Qnil;
  }

  xpathObj = xmlXPathEvalExpression(StringValueCStr(xpathExpr), xpathCtx);
  <span style="color: #7f007f;">if</span> (xpathObj == <span style="color: #008b8b;">NULL</span>) {
    fprintf(stderr, <span style="color: #8b2252;">"Error: unable to evaluate xpath expression \"%s\"\n"</span>, StringValueCStr(xpathExpr));
    xmlXPathFreeContext(xpathCtx);
    xmlFreeDoc(doc);
    <span style="color: #7f007f;">return</span> Qnil;
  }

  nodes = xpathObj-&gt;nodesetval;
  size = (nodes) ? nodes-&gt;nodeNr : 0;

  <span style="color: #7f007f;">if</span> (size == 1) {
    results = rb_str_new2(xmlNodeGetContent(nodes-&gt;nodeTab[0]));
  } <span style="color: #7f007f;">else</span> {
    <span style="color: #7f007f;">for</span> (i = 0; i &lt; size; ++i) {
      cur = nodes-&gt;nodeTab[i];
      rb_ary_push(results, rb_str_new2(xmlNodeGetContent(cur)));
    }
  }

  xmlXPathFreeObject(xpathObj);
  xmlXPathFreeContext(xpathCtx);

  <span style="color: #7f007f;">return</span> results;
}
</pre>

<ul>
<li>Here we define a function that accepts an xpath expression just
     like we had in our pure Ruby example. We setup our variables just
     like we did in our experiment with the exception of <code>VALUE      results</code>. This is the value that we will pass back to Ruby after
     we are done. We now see the reverse of our object packing,
     <code>Data_Get_Struct</code>. It's a type-safe wrapper around the <code>DATA_PTR</code>
     macro which essentially just returns the data we packed up in our
     constructor and places it inside the <code>doc</code> variable.
</li>
<li>The rest of this function looks pretty similar to our experiment
     with few exceptions. These are all Ruby/C interop functions that
     make it possible for C to understand the Ruby data and then pass
     it back so that Ruby can understand it.
</li>
<li>We already covered <code>StringValueCStr</code>, but we haven't seen
     <code>rb_str_new2</code> yet. This function, along with the other
     <code>rb_str_new</code> functions, turns a <code>char *</code> into a <code>VALUE</code> for Ruby
     to consume. <code>rb_str_new2</code> is the most commonly used of the
     conversion functions, because it automatically calculates the
     length of the string, making the function call more convienient.
</li>
<li><code>rb_ary_new</code> and <code>rb_ary_push</code> do exactly what you think they do.
</li>
<li>Let's wire up the search function:
</li>
</ul>


<strong><i>ext/xpanther/xpanther.c</i></strong>

<pre class="src src-c"><span style="color: #228b22;">void</span> <span style="color: #0000ff;">Init_xpanther</span>(<span style="color: #228b22;">void</span>)
{
  <span style="color: #228b22;">VALUE</span> <span style="color: #a0522d;">klass</span> = rb_define_class(<span style="color: #8b2252;">"XPanther"</span>, rb_cObject);
  rb_define_singleton_method(klass, <span style="color: #8b2252;">"new"</span>, constructor, 1);
  rb_define_method(klass, <span style="color: #8b2252;">"initialize"</span>, initialize, 1);
  rb_define_method(klass, <span style="color: #8b2252;">"search"</span>, search, 1);
}
</pre>

<ul>
<li>We need to do a little bit of housekeeping to make things build
     properly. First, adjust the includes in <code>xpanther.c</code> to include
     the libxml pieces from our experiment.
</li>
</ul>


<strong><i>ext/xpanther/xpanther.c</i></strong>

<pre class="src src-c"><span style="color: #483d8b;">#include</span> <span style="color: #8b2252;">&lt;ruby.h&gt;</span>
<span style="color: #483d8b;">#include</span> <span style="color: #8b2252;">&lt;libxml/tree.h&gt;</span>
<span style="color: #483d8b;">#include</span> <span style="color: #8b2252;">&lt;libxml/parser.h&gt;</span>
<span style="color: #483d8b;">#include</span> <span style="color: #8b2252;">&lt;libxml/xpath.h&gt;</span>
<span style="color: #483d8b;">#include</span> <span style="color: #8b2252;">&lt;libxml/xpathInternals.h&gt;</span>
</pre>

<ul>
<li>We also need to modify <code>extconf.rb</code> and tell it to link against
     libxml so that our extension can compile properly.
</li>
</ul>


<strong><i>ext/xpanther/extconf.rb</i></strong>

<pre class="src src-ruby">require <span style="color: #8b2252;">'mkmf'</span>
have_library(<span style="color: #8b2252;">"xml2"</span>)
find_header(<span style="color: #8b2252;">"libxml/tree.h"</span>, <span style="color: #8b2252;">"/usr/include/libxml2"</span>)
find_header(<span style="color: #8b2252;">"libxml/parser.h"</span>, <span style="color: #8b2252;">"/usr/include/libxml2"</span>)
find_header(<span style="color: #8b2252;">"libxml/xpath.h"</span>, <span style="color: #8b2252;">"/usr/include/libxml2"</span>)
find_header(<span style="color: #8b2252;">"libxml/xpathInternals.h"</span>, <span style="color: #8b2252;">"/usr/include/libxml2"</span>)
create_makefile(<span style="color: #8b2252;">'xpanther/xpanther'</span>)
</pre>

<ul>
<li>Since we moved around a bit inside the <code>xpanther.c</code> file, here's
     a complete sample.
</li>
</ul>


<strong><i>ext/xpanther/xpanther.c</i></strong>

<pre class="src src-c"><span style="color: #483d8b;">#include</span> <span style="color: #8b2252;">&lt;ruby.h&gt;</span>
<span style="color: #483d8b;">#include</span> <span style="color: #8b2252;">&lt;libxml/tree.h&gt;</span>
<span style="color: #483d8b;">#include</span> <span style="color: #8b2252;">&lt;libxml/parser.h&gt;</span>
<span style="color: #483d8b;">#include</span> <span style="color: #8b2252;">&lt;libxml/xpath.h&gt;</span>
<span style="color: #483d8b;">#include</span> <span style="color: #8b2252;">&lt;libxml/xpathInternals.h&gt;</span>

<span style="color: #7f007f;">static</span> <span style="color: #228b22;">void</span> <span style="color: #0000ff;">xml_free</span>(<span style="color: #228b22;">void</span> *<span style="color: #a0522d;">doc</span>) {
  xmlFreeDoc(doc);
}

<span style="color: #7f007f;">static</span> <span style="color: #228b22;">VALUE</span> <span style="color: #0000ff;">initialize</span>(<span style="color: #228b22;">VALUE</span> <span style="color: #a0522d;">self</span>, <span style="color: #228b22;">VALUE</span> <span style="color: #a0522d;">filename</span>)
{
  rb_iv_set(self, <span style="color: #8b2252;">"@filename"</span>, filename);
  <span style="color: #7f007f;">return</span> self;
}

<span style="color: #228b22;">VALUE</span> <span style="color: #0000ff;">constructor</span>(<span style="color: #228b22;">VALUE</span> <span style="color: #a0522d;">self</span>, <span style="color: #228b22;">VALUE</span> <span style="color: #a0522d;">filename</span>)
{
  <span style="color: #228b22;">xmlDocPtr</span> <span style="color: #a0522d;">doc</span>;
  <span style="color: #228b22;">VALUE</span> <span style="color: #a0522d;">argv</span>[1];
  <span style="color: #228b22;">VALUE</span> <span style="color: #a0522d;">t_data</span>;

  doc = xmlParseFile(StringValueCStr(filename));
  <span style="color: #7f007f;">if</span> (doc == <span style="color: #008b8b;">NULL</span>) {
    fprintf(stderr, <span style="color: #8b2252;">"Error: unable to parse file \"%s\"\n"</span>, StringValueCStr(filename));
    <span style="color: #7f007f;">return</span> Qnil;
  }

  t_data = Data_Wrap_Struct(self, 0, xml_free, doc);
  argv[0] = filename;
  rb_obj_call_init(t_data, 1, argv);
  <span style="color: #7f007f;">return</span> t_data;
}

<span style="color: #228b22;">VALUE</span> <span style="color: #0000ff;">search</span>(<span style="color: #228b22;">VALUE</span> <span style="color: #a0522d;">self</span>, <span style="color: #228b22;">VALUE</span> <span style="color: #a0522d;">xpathExpr</span>)
{
  <span style="color: #228b22;">VALUE</span> <span style="color: #a0522d;">results</span> = rb_ary_new();
  <span style="color: #228b22;">xmlDocPtr</span> <span style="color: #a0522d;">doc</span>;
  <span style="color: #228b22;">xmlXPathContextPtr</span> <span style="color: #a0522d;">xpathCtx</span>;
  <span style="color: #228b22;">xmlXPathObjectPtr</span> <span style="color: #a0522d;">xpathObj</span>;
  <span style="color: #228b22;">xmlNodeSetPtr</span> <span style="color: #a0522d;">nodes</span>;
  <span style="color: #228b22;">xmlNodePtr</span> <span style="color: #a0522d;">cur</span>;
  <span style="color: #228b22;">int</span> <span style="color: #a0522d;">size</span>;
  <span style="color: #228b22;">int</span> <span style="color: #a0522d;">i</span>;

  Data_Get_Struct(self, xmlDoc, doc);

  xpathCtx = xmlXPathNewContext(doc);
  <span style="color: #7f007f;">if</span> (xpathCtx == <span style="color: #008b8b;">NULL</span>) {
    fprintf(stderr, <span style="color: #8b2252;">"Error: unable to create new XPath context\n"</span>);
    xmlFreeDoc(doc);
    <span style="color: #7f007f;">return</span> Qnil;
  }

  xpathObj = xmlXPathEvalExpression(StringValueCStr(xpathExpr), xpathCtx);
  <span style="color: #7f007f;">if</span> (xpathObj == <span style="color: #008b8b;">NULL</span>) {
    fprintf(stderr, <span style="color: #8b2252;">"Error: unable to evaluate xpath expression \"%s\"\n"</span>, StringValueCStr(xpathExpr));
    xmlXPathFreeContext(xpathCtx);
    xmlFreeDoc(doc);
    <span style="color: #7f007f;">return</span> Qnil;
  }

  nodes = xpathObj-&gt;nodesetval;
  size = (nodes) ? nodes-&gt;nodeNr : 0;

  <span style="color: #7f007f;">if</span> (size == 1) {
    results = rb_str_new2(xmlNodeGetContent(nodes-&gt;nodeTab[0]));
  } <span style="color: #7f007f;">else</span> {
    <span style="color: #7f007f;">for</span> (i = 0; i &lt; size; ++i) {
      cur = nodes-&gt;nodeTab[i];
      rb_ary_push(results, rb_str_new2(xmlNodeGetContent(cur)));
    }
  }

  xmlXPathFreeObject(xpathObj);
  xmlXPathFreeContext(xpathCtx);

  <span style="color: #7f007f;">return</span> results;
}

<span style="color: #228b22;">void</span> <span style="color: #0000ff;">Init_xpanther</span>(<span style="color: #228b22;">void</span>)
{
  <span style="color: #228b22;">VALUE</span> <span style="color: #a0522d;">klass</span> = rb_define_class(<span style="color: #8b2252;">"XPanther"</span>, rb_cObject);
  rb_define_singleton_method(klass, <span style="color: #8b2252;">"new"</span>, constructor, 1);
  rb_define_method(klass, <span style="color: #8b2252;">"initialize"</span>, initialize, 1);
  rb_define_method(klass, <span style="color: #8b2252;">"search"</span>, search, 1);
}
</pre>

<ul>
<li>Now all we have to do is rebuild and reinstall our gem to give it
     a try. While we are at it we should also bump the version number.
</li>
</ul>




<pre class="src src-sh">$ gem build xpanther.gemspec 
  Successfully built RubyGem
  Name: xpanther
  Version: 0.0.1
  File: xpanther-0.0.1.gem
$ gem install xpanther-0.0.1.gem 
Building native extensions.  This could take a while...
Successfully installed xpanther-0.0.1
1 gem installed
Installing ri documentation for xpanther-0.0.1...
Installing RDoc documentation for xpanther-0.0.1...
$ irb -rubygems -rxpanther
&gt;&gt; <span style="color: #a0522d;">document</span> = XPanther.new(<span style="color: #8b2252;">"examples/twitter.xml"</span>)
=&gt; <span style="color: #b22222;">#</span><span style="color: #b22222;">&lt;XPanther:0x108eb7c98&gt;</span>
&gt;&gt; document.search(<span style="color: #8b2252;">"/statuses/status/text"</span>).count
=&gt; 20
&gt;&gt; document.search(<span style="color: #8b2252;">"/statuses/status/text"</span>).first
=&gt; <span style="color: #8b2252;">"Hoje sai com a @is_nanny"</span>
</pre>

</div>
</div>

</div>

<div id="outline-container-7" class="outline-2">
<h2 id="sec-7"><span class="section-number-2">7</span> The results!</h2>
<div class="outline-text-2" id="text-7">

<ul>
<li>It's time to see how much we gained from our efforts. Let's put together a test
</li>
</ul>


<strong><i>examples/extended.rb</i></strong>

<pre class="src src-ruby">require <span style="color: #8b2252;">'rubygems'</span>
require <span style="color: #8b2252;">'xpanther'</span>

document = <span style="color: #228b22;">XPanther</span>.new(<span style="color: #8b2252;">"twitter.xml"</span>)
results = document.search(<span style="color: #8b2252;">"/statuses/status/text"</span>)
puts results.count
puts results.first
</pre>

<ul>
<li>We can time our run as we did before and take a look at the difference.
</li>
</ul>




<pre class="src src-sh">$ time ruby extended.rb
20
Hoje sai com a @is_nanny
ruby extended.rb  0.02s user 0.01s system 95% cpu 0.029 total
</pre>

</div>

</div>

<div id="outline-container-8" class="outline-2">
<h2 id="sec-8"><span class="section-number-2">8</span> References</h2>
<div class="outline-text-2" id="text-8">

<ul>
<li>RubyGems Guides, C Extensions <a href="http://guides.rubygems.org/c-extensions/">http://guides.rubygems.org/c-extensions/</a>
</li>
<li>Programming Ruby, Extending Ruby <a href="http://ruby-doc.org/docs/ProgrammingRuby/html/ext_ruby.html">http://ruby-doc.org/docs/ProgrammingRuby/html/ext<sub>ruby</sub>.html</a>
</li>
</ul>

</div>
</div>
</div>

<div id="postamble">
<p class="date">Date: 2012-02-07 08:40:01 CST</p>
<p class="author">Author: Aaron Bedra</p>
<p class="creator">Org version 7.8.03 with Emacs version 24</p>
<a href="http://validator.w3.org/check?uri=referer">Validate XHTML 1.0</a>

</div>
</body>
</html>
